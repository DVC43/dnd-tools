<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Magic Item Backstory Generator</title>
<style>
  /* Outer parchment card – same feel as #reagent-generator */
  #item-lore-generator.parchment-table {
    font-family:"Garamond","Georgia",serif;
    color:#111;
    padding:20px;
    border:2px solid #660000;
    border-radius:6px;
    max-width:1550px;
    margin:1.5rem auto 0;
    background:linear-gradient(180deg,#fafafa 0%,#f0f0f0 100%);
    box-shadow:0 0 12px rgba(0,0,0,0.25);
  }

  #item-lore-generator h2 {
    margin:0 0 0.5rem;
    font-size:1.4rem;
    text-align:center;
  }

  #item-lore-generator p.note {
    margin:0 0 0.75rem;
    font-size:0.9rem;
    font-style:italic;
    text-align:center;
  }

  #item-lore-generator .small {
    font-size:0.85rem;
    font-style:italic;
    color:#444;
    margin-top:0.75rem;
  }

  /* Inner “rules text” panels */
  #item-lore-generator .lg-panel {
    border:2px solid #7b1113;
    background:#ffffff;
    padding:12px 14px;
    border-radius:4px;
    margin-top:0.75rem;
  }

  #item-lore-generator .lg-section-title {
    font-weight:bold;
    margin-bottom:0.25rem;
  }

  /* Buttons – cloned from .rg-button style */
  #item-lore-generator .lg-button {
    display:block;
    width:100%;
    padding:4px 10px;
    border-radius:4px;
    border:1px solid #660000;
    cursor:pointer;
    font-size:0.9rem;
    font-weight:600;
    font-family:inherit;
    background:#7b1113;
    color:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.35);
    transition:background 0.1s ease-out,
               box-shadow 0.1s ease-out,
               transform 0.05s ease-out;
    margin:0 0 0.7rem;
  }

  #item-lore-generator .lg-button:hover {
    background:#990000;
    box-shadow:0 4px 10px rgba(0,0,0,0.45);
    transform:translateY(-1px);
  }

  #item-lore-generator .lg-button:active {
    transform:translateY(0);
    box-shadow:0 2px 6px rgba(0,0,0,0.35);
  }

  /* Output card blocks – match #rg-card */
  #item-lore-generator .lg-card {
    border-radius:4px;
    border:1px solid #c0c0c0;
    padding:0.9rem 0.9rem 0.8rem;
    background:#ffffff;
    font-size:0.9rem;
    margin-top:0.25rem;
  }

  #item-lore-generator .lg-card p {
    margin:0.5rem 0;
    line-height:1.45;
  }

  #item-lore-generator .lg-output {
    margin:0.25rem 0;
    min-height:2.2em;
    white-space:pre-wrap;
  }

  #item-lore-generator .lg-output.lg-lore {
    min-height:4em;
  }

  #item-lore-generator .lg-meta {
    margin-top:0.25rem;
    font-size:0.82rem;
    font-style:italic;
    color:#555;
  }

  @media (max-width:700px){
    #item-lore-generator.parchment-table {
      padding:14px;
    }
  }
</style>
</head>
<body>
<div id="item-lore-generator" class="parchment-table">
  <h2>Magic Item Background Generator</h2>
  <p class="note">
    Discover details about an odd trinket, magical item, or dusty curio.
    <br>
    <br>
    Details provided are suggestions, and can be used in part or in whole.  Always adjust to fit your table’s tone and tier of play.
  </p>

  <button id="rollTraitsBtn" class="lg-button">Roll Traits</button>
  <button id="generateLoreBtn" class="lg-button">Generate Lore Paragraph</button>

  <!-- Q1: Creator / Intended User -->
  <div class="lg-panel">
    <div class="lg-section-title">Who Created It or Was Intended to Use It?</div>
    <div class="lg-card">
      <div id="originOutput" class="lg-output"></div>
      <div id="metaOutput" class="lg-meta"></div>
    </div>
  </div>

  <!-- Q2: History -->
  <div class="lg-panel">
    <div class="lg-section-title">What are some details from the item's history?</div>
    <div class="lg-card">
      <div id="historyOutput" class="lg-output"></div>
    </div>
  </div>

  <!-- Public Reputation -->
  <div class="lg-panel">
    <div class="lg-section-title">Common Reputation</div>
    <div class="lg-card">
      <div id="reputationOutput" class="lg-output"></div>
    </div>
  </div>

  <!-- Current Power State -->
  <div class="lg-panel">
    <div class="lg-section-title">Current Power State</div>
    <div class="lg-card">
      <div id="powerStateOutput" class="lg-output"></div>
    </div>
  </div>
  
  <!-- Q3: Location -->
  <div class="lg-panel">
    <div class="lg-section-title">Last Known Location?</div>
    <div class="lg-card">
      <div id="locationOutput" class="lg-output"></div>
    </div>
  </div>

  <!-- Q4: NPC -->
  <div class="lg-panel">
    <div class="lg-section-title">NPC Who Knows About It?</div>
    <div class="lg-card">
      <div id="witnessOutput" class="lg-output"></div>
    </div>
  </div>

  <!-- Who Wants It Destroyed -->
  <div class="lg-panel">
    <div class="lg-section-title">Who Wants It Destroyed?</div>
    <div class="lg-card">
      <div id="destroyerOutput" class="lg-output"></div>
    </div>
  </div>
  
  <!-- Combined Lore -->
  <div class="lg-panel">
    <div class="lg-section-title">Item Lore</div>
    <div class="lg-card">
      <div id="loreOutput" class="lg-output lg-lore"></div>
    </div>
  </div>
</div>
  
<script>
(function () {
  "use strict";

  // ---------------------------
  //  DATA: CREATORS / COMMISSIONERS
  // ---------------------------

  const CREATORS_COMMISSIONERS = {
    good: [
      {
        id: "paladin",
        type: "class",
        size: "single",
        noun: "paladin",
        isCreator: false,
        tags: ["celestial", "duty", "courage"]
      },
      {
        id: "deva",
        type: "npc",
        size: "single",
        noun: "deva",
        isCreator: true,
        tags: ["celestial", "protection", "wisdom"]
      },
      {
        id: "artisan_guild",
        type: "npc",
        size: "group",
        noun: "artisan guild",
        isCreator: false,
        tags: ["commerce", "craft", "travel"]
      },
      {
        id: "wizard_council",
        type: "class",
        size: "group",
        noun: "wizard council",
        isCreator: true,
        tags: ["arcane", "knowledge", "wisdom"]
      }
      // ADD MORE GOOD-ALIGNED CREATORS/COMMISSIONERS HERE
    ],
    evil: [
      {
        id: "fallen_paladin",
        type: "class",
        size: "single",
        noun: "oathbreaker paladin",
        isCreator: true,
        tags: ["profane", "war", "fear"]
      },
      {
        id: "hag_coven",
        type: "npc",
        size: "group",
        noun: "hag coven",
        isCreator: true,
        tags: ["deceit", "corruption", "eldritch"]
      },
      {
        id: "thieves_guild",
        type: "npc",
        size: "group",
        noun: "thieves' guild",
        isCreator: false,
        tags: ["criminal", "corruption", "deception"]
      },
      {
        id: "lich",
        type: "npc",
        size: "single",
        noun: "lich",
        isCreator: true,
        tags: ["fear", "corruption", "domination"]
      }
      // ADD MORE EVIL-ALIGNED CREATORS/COMMISSIONERS HERE
    ]
  };

  const ALIGNMENT_AXES = ["good", "evil"];

  function pickRandomOriginAxis() {
    return ALIGNMENT_AXES[Math.floor(Math.random() * ALIGNMENT_AXES.length)];
  }

  function pickCreatorForAxis(axis) {
    const pool = CREATORS_COMMISSIONERS[axis];
    if (!pool || pool.length === 0) return null;
    return randomFrom(pool);
  }

  // ---------------------------
  //  DATA: TAG TONES
  // ---------------------------

  const TAG_DEFINITIONS = {
    // good-leaning tags
    duty:       { tone: "good" },
    courage:    { tone: "good" },
    protection: { tone: "good" },
    wisdom:     { tone: "good" },
    healing:    { tone: "good" },
    mercy:      { tone: "good" },

    // evil-leaning tags
    corruption: { tone: "evil" },
    fear:       { tone: "evil" },
    domination: { tone: "evil" },
    deceit:     { tone: "evil" },
    profane:    { tone: "evil" },
    criminal:   { tone: "evil" },

    // neutral tags
    arcane:     { tone: "neutral" },
    knowledge:  { tone: "neutral" },
    craft:      { tone: "neutral" },
    travel:     { tone: "neutral" },
    forest:     { tone: "neutral" },
    trade:      { tone: "neutral" },
    eldritch:   { tone: "neutral" },

    // example bridge tags
    celestial:  { tone: "good" },
    war:        { tone: "evil" }

    // ADD MORE TAG DEFINITIONS HERE
  };

  function getTagToneStats(tags) {
    const stats = { good: 0, evil: 0, neutral: 0 };
    for (let i = 0; i < tags.length; i++) {
      const t = tags[i];
      const tone = TAG_DEFINITIONS[t]?.tone || "neutral";
      stats[tone]++;
    }
    return stats;
  }

  function inferDominantTagTone(tags) {
    const stats = getTagToneStats(tags);
    if (stats.good > stats.evil) return "good";
    if (stats.evil > stats.good) return "evil";
    return "neutral";
  }

  // ---------------------------
  //  ITEM ALIGNMENT & STATE
  // ---------------------------

  function determineItemAlignment(originAxis, tags) {
    const dominantTone = inferDominantTagTone(tags);

    if (dominantTone === "neutral") {
      return {
        itemAxis: originAxis,
        itemState: "aligned"
      };
    }

    if (dominantTone === originAxis) {
      return {
        itemAxis: originAxis,
        itemState: "aligned"
      };
    }

    if (originAxis === "good" && dominantTone === "evil") {
      return {
        itemAxis: "evil",
        itemState: "corrupted"
      };
    }

    if (originAxis === "evil" && dominantTone === "good") {
      return {
        itemAxis: "good",
        itemState: "sanctified"
      };
    }

    return {
      itemAxis: originAxis,
      itemState: "aligned"
    };
  }

  // ---------------------------
  //  MOTIVATIONS BY TAG & ORIGIN AXIS
  // ---------------------------

  const TAG_MOTIVATIONS = {
    good: {
      duty: [
        "to honor a sacred oath",
        "to fulfill a solemn vow"
      ],
      courage: [
        "to arm a champion against the coming darkness",
        "to give strength to those who stand their ground"
      ],
      protection: [
        "to shield the innocent from harm",
        "to guard those who could not guard themselves"
      ],
      commerce: [
        "to reward faithful service with more than coin",
        "as a masterwork commission for a trusted patron"
      ],
      craft: [
        "as a testament to unmatched craftsmanship",
        "to prove that mortal hands can shape wonders"
      ],
      travel: [
        "to aid long and perilous journeys",
        "to see its bearer safely through distant roads"
      ],
      wisdom: [
        "to guide the worthy with quiet insight",
        "to preserve hard-won wisdom in steel and spell"
      ],
      // ADD MORE GOOD-AXIS TAG MOTIVATIONS HERE
      _fallback: [
        "to aid those who stand against the darkness",
        "to serve a cause greater than any one bearer"
      ]
    },
    evil: {
      war: [
        "to win a bloody and lopsided war",
        "to crush their enemies on the battlefield"
      ],
      fear: [
        "to spread paralyzing fear wherever it appears",
        "so that its very name would make the boldest tremble"
      ],
      deceit: [
        "to turn allies against each other",
        "to ensure that lies would cut as sharply as any blade"
      ],
      corruption: [
        "to taint whatever it touches",
        "to slowly twist hearts and hopes alike"
      ],
      eldritch: [
        "to anchor a fragment of something that should not exist",
        "to bind powers no sane mind would willingly call upon"
      ],
      domination: [
        "to bend will and flesh to a single cruel purpose",
        "to remind the world who held true power"
      ],
      criminal: [
        "to tilt every deal and every heist in their favor",
        "to make the law itself seem powerless"
      ],
      // ADD MORE EVIL-AXIS TAG MOTIVATIONS HERE
      _fallback: [
        "to further their own ruthless ambitions",
        "to remake the world in their own grim image"
      ]
    }
  };

  function buildMotivationClause(originAxis, tags) {
    const axisTable = TAG_MOTIVATIONS[originAxis] || {};
    for (let i = 0; i < tags.length; i++) {
      const tag = tags[i];
      if (axisTable[tag]) {
        return randomFrom(axisTable[tag]);
      }
    }
    const fallback = axisTable._fallback || [
      originAxis === "good"
        ? "to aid those who stand against the darkness"
        : "to further their own ruthless ambitions"
    ];
    return randomFrom(fallback);
  }

  // ---------------------------
  //  TEXT HELPERS
  // ---------------------------

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function aOrAn(phrase) {
    const word = phrase.trim().toLowerCase();
    const first = word[0];
    return "aeiou".includes(first) ? "An" : "A";
  }

  const RACE_ADJECTIVES = [
    "human",
    "elven",
    "dwarven",
    "dragonborn",
    "tiefling",
    "halfling"
    // ADD MORE RACE ADJECTIVES HERE IF DESIRED
  ];

  function buildSubjectNoun(creator) {
    let base = creator.noun;

    if (creator.type === "class" && Math.random() < 0.6) {
      const race = randomFrom(RACE_ADJECTIVES);
      base = race + " " + creator.noun;
    }

    const article = aOrAn(base);
    return article + " " + base;
  }

  // ---------------------------
  //  TRANSFORMATION CAUSES
  // ---------------------------

  const CORRUPTION_CAUSES = [
    {
      id: "fallen_bearer",
      tone: "woe",
      kind: "corruption",
      summaryTemplates: [
        "Its fall began when its last celebrated bearer broke their vows, and the item’s magic darkened in answer to that betrayal.",
        "A once-honored champion turned traitor while wielding the item, and their fall stained its power.",
        "The item’s purpose curdled when the hero who bore it chose cruelty over mercy at a pivotal moment."
      ],
      hooks: {
        linkedToNotoriousIndividual: true,
        linkedToNotoriousGroup: false,
        eventOfWeal: false,
        eventOfWoe: true,
        thoughtLostOrDestroyed: true,
        activelySoughtByNotorious: true,
        hasRumors: true,
        hasProphecy: false
      }
    },
    {
      id: "bargain_with_darkness",
      tone: "woe",
      kind: "corruption",
      summaryTemplates: [
        "In a moment of fear and desperation, a keeper of the item bargained with darker powers through it, and the bargain never fully released its grip.",
        "Someone used the item as the focus of a forbidden pact, and the magic that answered warped it from within.",
        "The item was offered up as collateral in a blasphemous bargain, and the patron’s influence seeped into it."
      ],
      hooks: {
        linkedToNotoriousIndividual: true,
        linkedToNotoriousGroup: true,
        eventOfWeal: false,
        eventOfWoe: true,
        thoughtLostOrDestroyed: false,
        activelySoughtByNotorious: true,
        hasRumors: true,
        hasProphecy: true
      }
    },
    {
      id: "catastrophic_ritual",
      tone: "woe",
      kind: "corruption",
      summaryTemplates: [
        "A grand ritual meant for protection or healing went catastrophically wrong, and the backlash twisted the item at its heart.",
        "It served as the anchor of a warding rite that failed, drinking in the unleashed harm instead of turning it aside.",
        "The item survived a magical disaster that shattered an entire sanctum, absorbing fragments of the unleashed horror."
      ],
      hooks: {
        linkedToNotoriousIndividual: false,
        linkedToNotoriousGroup: true,
        eventOfWeal: false,
        eventOfWoe: true,
        thoughtLostOrDestroyed: true,
        activelySoughtByNotorious: false,
        hasRumors: true,
        hasProphecy: false
      }
    }
    // ADD MORE CORRUPTION CAUSES HERE
  ];

  const SANCTIFICATION_CAUSES = [
    {
      id: "rite_of_cleansing",
      tone: "weal",
      kind: "sanctification",
      summaryTemplates: [
        "After its crimes became known, it was subjected to a long and perilous rite of cleansing that burned away much of its original malice.",
        "A circle of devoted clergy worked a slow purification upon the item, unraveling layer after layer of its corruption.",
        "In a hidden shrine, patient rites of contrition and renewal gradually redirected the item’s power toward gentler ends."
      ],
      hooks: {
        linkedToNotoriousIndividual: false,
        linkedToNotoriousGroup: true,
        eventOfWeal: true,
        eventOfWoe: false,
        thoughtLostOrDestroyed: false,
        activelySoughtByNotorious: true,
        hasRumors: true,
        hasProphecy: true
      }
    },
    {
      id: "martyrs_blood",
      tone: "weal",
      kind: "sanctification",
      summaryTemplates: [
        "When a martyr fell defending the helpless, their blood soaked into the item and rewrote some part of its purpose.",
        "A final selfless sacrifice wielding the item against overwhelming odds left a permanent mark of grace upon it.",
        "The last stand of a defender who refused to use the item for cruelty transformed the way its magic answers the world."
      ],
      hooks: {
        linkedToNotoriousIndividual: true,
        linkedToNotoriousGroup: false,
        eventOfWeal: true,
        eventOfWoe: true,
        thoughtLostOrDestroyed: true,
        activelySoughtByNotorious: true,
        hasRumors: true,
        hasProphecy: false
      }
    },
    {
      id: "claimed_by_higher_power",
      tone: "weal",
      kind: "sanctification",
      summaryTemplates: [
        "A higher power laid quiet claim to the item, slowly overwriting its cruel design with a new, protective bent.",
        "It was seized and repurposed by a patron of light, who bent its workings toward defense rather than domination.",
        "The item was taken into the custody of a sacred order, and over generations its nature shifted under their stewardship."
      ],
      hooks: {
        linkedToNotoriousIndividual: false,
        linkedToNotoriousGroup: true,
        eventOfWeal: true,
        eventOfWoe: false,
        thoughtLostOrDestroyed: false,
        activelySoughtByNotorious: false,
        hasRumors: true,
        hasProphecy: true
      }
    }
    // ADD MORE SANCTIFICATION CAUSES HERE
  ];

  function pickTransformationDetails(itemState, originAxis, itemAxis, creator) {
    if (itemState === "corrupted") {
      const cause = randomFrom(CORRUPTION_CAUSES);
      const summary = randomFrom(cause.summaryTemplates);
      return {
        id: cause.id,
        kind: cause.kind,
        tone: cause.tone,
        summary: summary,
        hooks: cause.hooks
      };
    }

    if (itemState === "sanctified") {
      const cause = randomFrom(SANCTIFICATION_CAUSES);
      const summary = randomFrom(cause.summaryTemplates);
      return {
        id: cause.id,
        kind: cause.kind,
        tone: cause.tone,
        summary: summary,
        hooks: cause.hooks
      };
    }

    return null;
  }

  // ---------------------------
  //  CREATOR SENTENCE GENERATION (Q1)
  // ---------------------------

  function buildCreatorSentences(originAxis, itemAxis, itemState, creator) {
    const subject = buildSubjectNoun(creator);
    const motivation = buildMotivationClause(originAxis, creator.tags);

    let sentence1;
    if (creator.isCreator) {
      sentence1 = subject + " crafted this item " + motivation + ".";
    } else {
      sentence1 = subject + " commissioned this item " + motivation + ".";
    }

    const STATE_SENTENCE2 = {
      aligned: {
        good: {
          single: [
            "Those who know the tale say a trace of their quiet resolve still clings to its magic.",
            "It is said the creator’s original hope yet lingers within its enchantment.",
            "The item still answers as it was first intended, faithful to its original cause."
          ],
          group: [
            "Even now, old stories speak of their shared purpose woven into every line and edge of the design.",
            "Their collective intent is said to linger, bound into the item like a solemn oath.",
            "The cooperation that forged it is still felt whenever its power is called upon."
          ]
        },
        evil: {
          single: [
            "Those who remember the story insist that a fragment of their malice still stirs within it.",
            "It is whispered that the maker’s cruelty yet murmurs in the depths of its magic.",
            "The item still bears the unmistakable signature of its creator’s dark will."
          ],
          group: [
            "Whispers claim their cruel intent soaked into the item and never truly faded.",
            "Their shared malice lingers like a stain that no age has yet washed clean.",
            "The united wicked purpose that birthed it is said to echo within its power."
          ]
        }
      },

      corrupted: {
        single: [
          "Yet over time, its original purpose was bent and darkened, until the magic within no longer served the vows that first shaped it.",
          "Some calamity warped the item’s original intent, turning a once-noble creation toward darker ends.",
          "What was meant for good was slowly poisoned by forces the creator never foresaw."
        ],
        group: [
          "In the years that followed, the ideals of its makers were eroded and twisted, until the item answered to darker purposes altogether.",
          "A shared tragedy or betrayal corrupted the magic they once unified around, reshaping the artifact into something grim.",
          "The harmony that first empowered it gave way to corruption, and the item remembers that fall more clearly than its birth."
        ]
      },

      sanctified: {
        single: [
          "In time, however, powers of light claimed it, reshaping its purpose in quiet defiance of the will that first forged it.",
          "Through trial, prayer, or sacrifice, its dark origin was overwritten by a gentler calling.",
          "Though born of wicked hands, the item was later turned toward mercy and light."
        ],
        group: [
          "Through long effort and shared sacrifice, its cruel origins were scoured away and replaced with new purpose.",
          "What the group made for darkness was later unmade and reforged in the image of redemption.",
          "The united wicked will that shaped it was ultimately overturned by a higher, brighter calling."
        ]
      }
    };

    let sentence2;

    if (itemState === "aligned") {
      sentence2 = randomFrom(
        STATE_SENTENCE2.aligned[originAxis][creator.size]
      );
    } else if (itemState === "corrupted") {
      sentence2 = randomFrom(
        STATE_SENTENCE2.corrupted[creator.size]
      );
    } else if (itemState === "sanctified") {
      sentence2 = randomFrom(
        STATE_SENTENCE2.sanctified[creator.size]
      );
    } else {
      sentence2 = "Over the years, its true nature has grown tangled in conflicting tales and half-remembered prayers.";
    }

    return sentence1 + " " + sentence2;
  }

  // ---------------------------
  //  Q1: generateCreatorOrigin()
  // ---------------------------

  function generateCreatorOrigin() {
    const originAxis = pickRandomOriginAxis();
    const creator = pickCreatorForAxis(originAxis);

    if (!creator) {
      return {
        originAxis: originAxis,
        itemAxis: originAxis,
        itemState: "aligned",
        creator: null,
        text: "No suitable creator or commissioner could be found.",
        transformation: null
      };
    }

    const alignmentInfo = determineItemAlignment(originAxis, creator.tags);
    const itemAxis = alignmentInfo.itemAxis;
    const itemState = alignmentInfo.itemState;
    const text = buildCreatorSentences(originAxis, itemAxis, itemState, creator);

    const transformation = pickTransformationDetails(
      itemState,
      originAxis,
      itemAxis,
      creator
    );

    return {
      originAxis: originAxis,
      itemAxis: itemAxis,
      itemState: itemState,
      creator: creator,
      text: text,
      transformation: transformation
    };
  }

  // ---------------------------
  //  Q2 VARIATIONS
  // ---------------------------

  const HISTORY_OPENERS = {
    goodAligned: [
      "Over the years, the item passed through worthy hands, appearing at the edges of stories about hard-won victories and narrow escapes.",
      "In old chronicles, the item appears whenever desperate defenses somehow held just long enough for help to arrive.",
      "Ballads and battle accounts alike mention the item in passing, often at moments when courage refused to yield."
    ],
    evilAligned: [
      "In most accounts, the item surfaces in the wake of misfortune, its presence marking moments when events took a darker turn.",
      "Tax records, casualty lists, and hushed confessions alike place the item near calamities no one wishes to revisit.",
      "Wherever rumors of sudden ruin collect, the item’s name is never far behind, like a stain that will not wash out."
    ]
  };

  const EVENT_SENTENCES = {
    both: [
      "Chroniclers argue whether it brought more salvation or suffering in the end, for it turned the tide of blessings and disasters in equal measure.",
      "Debates in lecture halls and taverns alike circle back to the same puzzle: did the item save more lives than it cost?",
      "Some claim the item merely magnifies what is already present, pointing to a history filled with both miracles and catastrophes."
    ],
    weal: [
      "Those who study old campaigns credit the item with turning the tide of at least one desperate battle in favor of the innocent.",
      "Records of near-impossible victories often include a curious note about an unnamed relic that shone brighter when hope was fading.",
      "Local legends attribute an unlikely number of last-minute rescues and reversals of fortune to the item’s quiet influence."
    ],
    woe: [
      "In hushed tones, historians blame it for at least one tragedy that scarred an entire region.",
      "Discreet reports link the item to disasters that official records prefer to call ‘unavoidable’ or ‘unforeseen’.",
      "Whenever people mutter about towns that vanished or armies that broke without warning, the item’s name eventually surfaces."
    ]
  };

  const FATE_SENTENCES = {
    lostAndSought: [
      "For a long span it was believed lost or destroyed, yet powerful factions still quietly search for any trace that the item might have survived.",
      "Officially the item no longer exists; unofficially, there is a small industry devoted to proving that claim wrong.",
      "The more confidently scholars declare it gone forever, the more coin changes hands in shadowed corners to find it again."
    ],
    lostOnly: [
      "Most accounts insist the item was lost or destroyed long ago, though doubt lurks between the lines of those reports.",
      "Archivists mark the item as ‘presumed destroyed’, but the question mark next to the date has never been erased.",
      "Stories agree on the disaster that supposedly ended the item’s tale, but disagree suspiciously on exactly what became of it."
    ],
    soughtOnly: [
      "Despite the dangers attached to its name, collectors and ambitious powers alike continue to hunt for where it might have gone.",
      "Maps, coded letters, and half-burned journals all hint that someone, somewhere, is always searching for the item.",
      "The price offered for credible news of its whereabouts has risen with each generation, drawing in hunters of every stripe."
    ]
  };

  const RUMOR_PROPHECY_SENTENCES = {
    both_corrupted: [
      "Tavern tales and half-forgotten prophecies alike warn that if it resurfaces in the hands of the wrong bearer, an old disaster may play itself out once more.",
      "Street whispers and apocalyptic sermons agree on one thing: the item should never again answer a cruel will.",
      "Some say the next time the item is raised in anger, the world will not be as forgiving as it was the last time."
    ],
    both_other: [
      "Quiet rumors and obscure prophecies both suggest that the item is fated to appear again when the balance of the age wavers.",
      "Priests and hedge-seers alike hint that the item is tied to some turning point yet to come.",
      "Scattered visions and cryptic verses point to the item as a hinge on which a future age may quietly turn."
    ],
    rumorsOnly: [
      "Common folk embroider the story with rumors, insisting it brings uncanny fortune or calamity to those who claim it.",
      "Every region touched by its legend has its own version of the tale, none of them quite agreeing on whether it is a blessing or a curse.",
      "Children dare each other to repeat the item’s name at night, as if expecting something to answer from the dark."
    ],
    prophecyOnly: [
      "Esoteric texts hint at a prophecy that places the item at the center of some future turning point, though details are frustratingly vague.",
      "A handful of obscure prophetic fragments seem to describe the item obliquely, as if even the seers were wary of naming it outright.",
      "Among certain circles, it is quietly accepted that the item has not finished its part in the world’s unfolding story."
    ]
  };

  function buildAlignedHooks(originAxis, creator) {
    const isGroup = creator.size === "group";

    return {
      linkedToNotoriousIndividual: !isGroup,
      linkedToNotoriousGroup: isGroup,
      eventOfWeal: originAxis === "good",
      eventOfWoe: originAxis === "evil",
      thoughtLostOrDestroyed: Math.random() < 0.5,
      activelySoughtByNotorious: true,
      hasRumors: true,
      hasProphecy: Math.random() < 0.3
    };
  }

  function mergeHooks(a, b) {
    const result = {};
    const keys = [
      "linkedToNotoriousIndividual",
      "linkedToNotoriousGroup",
      "eventOfWeal",
      "eventOfWoe",
      "thoughtLostOrDestroyed",
      "activelySoughtByNotorious",
      "hasRumors",
      "hasProphecy"
    ];
    for (let i = 0; i < keys.length; i++) {
      const k = keys[i];
      result[k] = !!(a && a[k]) || !!(b && b[k]);
    }
    return result;
  }

  function buildNotorietySentence(itemAxis, hooks) {
    if (!hooks.linkedToNotoriousIndividual && !hooks.linkedToNotoriousGroup) {
      return null;
    }

    const isGood = itemAxis === "good";

    if (hooks.linkedToNotoriousIndividual && hooks.linkedToNotoriousGroup) {
      return isGood
        ? "Legends tie it to a famed champion and the order that once rode beside them, each leaving their mark on the tales told of the item."
        : "The item’s grim reputation is bound up with a feared warlord and the ruthless company that followed their banner.";
    }

    if (hooks.linkedToNotoriousIndividual) {
      return isGood
        ? "Many stories center on a single renowned bearer whose deeds elevated the item to near-mythic status."
        : "Whispered accounts speak of a singular villain whose atrocities etched the item’s name into history.";
    }

    return isGood
      ? "Its name often appears in chronicles of a storied order, cited whenever their greatest victories are recounted."
      : "The item is closely associated with a secretive cabal, mentioned in the margins of inquisitorial records and suppressed histories alike.";
  }

  function buildEventSentence(hooks) {
    const weal = hooks.eventOfWeal;
    const woe = hooks.eventOfWoe;

    if (weal && woe) {
      return randomFrom(EVENT_SENTENCES.both);
    }
    if (weal) {
      return randomFrom(EVENT_SENTENCES.weal);
    }
    if (woe) {
      return randomFrom(EVENT_SENTENCES.woe);
    }
    return null;
  }

  function buildFateSentence(hooks) {
    const lost = hooks.thoughtLostOrDestroyed;
    const sought = hooks.activelySoughtByNotorious;

    if (lost && sought) {
      return randomFrom(FATE_SENTENCES.lostAndSought);
    }
    if (lost) {
      return randomFrom(FATE_SENTENCES.lostOnly);
    }
    if (sought) {
      return randomFrom(FATE_SENTENCES.soughtOnly);
    }
    return null;
  }

  function buildRumorProphecySentence(hooks, itemState) {
    const hasRumors = hooks.hasRumors;
    const hasProphecy = hooks.hasProphecy;

    if (!hasRumors && !hasProphecy) return null;

    if (hasRumors && hasProphecy) {
      if (itemState === "corrupted") {
        return randomFrom(RUMOR_PROPHECY_SENTENCES.both_corrupted);
      }
      return randomFrom(RUMOR_PROPHECY_SENTENCES.both_other);
    }

    if (hasRumors) {
      return randomFrom(RUMOR_PROPHECY_SENTENCES.rumorsOnly);
    }

    // hasProphecy only
    return randomFrom(RUMOR_PROPHECY_SENTENCES.prophecyOnly);
  }

  function generateItemHistory(originData) {
    if (!originData || !originData.creator) {
      return {
        text: "Little is known of the item’s history beyond scattered, unreliable tales.",
        hooks: {}
      };
    }

    const originAxis = originData.originAxis;
    const itemAxis = originData.itemAxis;
    const itemState = originData.itemState;
    const creator = originData.creator;
    const transformation = originData.transformation;

    let baseHooks;
    if (transformation) {
      baseHooks = transformation.hooks || {};
    } else {
      baseHooks = buildAlignedHooks(originAxis, creator);
    }

    const finalHooks = mergeHooks(baseHooks, null);

    const sentences = [];

    if (transformation && transformation.summary) {
      sentences.push(transformation.summary);
    } else {
      if (originAxis === "good") {
        sentences.push(randomFrom(HISTORY_OPENERS.goodAligned));
      } else {
        sentences.push(randomFrom(HISTORY_OPENERS.evilAligned));
      }
    }

    const notorietySentence = buildNotorietySentence(itemAxis, finalHooks);
    if (notorietySentence) sentences.push(notorietySentence);

    const eventSentence = buildEventSentence(finalHooks);
    if (eventSentence) sentences.push(eventSentence);

    const fateSentence = buildFateSentence(finalHooks);
    if (fateSentence) sentences.push(fateSentence);

    const rpSentence = buildRumorProphecySentence(finalHooks, itemState);
    if (rpSentence) sentences.push(rpSentence);

    const text = sentences.join(" ");

    return {
      text: text,
      hooks: finalHooks
    };
  }

  // ---------------------------
  //  PUBLIC REPUTATION
  // ---------------------------
  // How "most people" talk about the item.
  // Keys:
  //   itemAxis: "good" | "evil"
  //   stateKey: "aligned" | "sanctified" | "corrupted"
  //   prominence: "prominent" | "obscure"
  const REPUTATION_SENTENCES = {
    good: {
      aligned: {
        prominent: [
          "Most folk know it as a lucky relic, the sort of thing minstrels mention when heroes pull off impossible rescues.",
          "In taverns, it’s described as a charm of last chances, turning certain defeat into narrow victories.",
          "Among the devout, its name is invoked like a minor saint’s, credited with quiet little miracles."
        ],
        obscure: [
          "Outside a few dusty chapels, hardly anyone recognizes its name, though older villagers sometimes nod at mention of 'that old blessing'.",
          "Scholars insist it was once a cherished relic, but most people treat the story as just another fireside comfort.",
          "For most, it is one more half-believed tale, a relic that might exist somewhere but rarely matters in daily life."
        ]
      },
      sanctified: {
        prominent: [
          "What most people know is the simple version: a wicked thing tamed by courage and prayer.",
          "Children learn the story as a parable, the 'dark relic that learned to do better', whether or not the details are accurate.",
          "Preachers point to it as proof that even the foulest tools can be turned to better ends."
        ],
        obscure: [
          "A few religious texts allude to a 'cleansed relic', but the common telling leaves out just how dark its origin truly was.",
          "In some regions, people speak of it only in hints, as if unsure whether to call it a miracle or a lingering warning.",
          "Those who have heard the story tend to remember only the redemption, not the long shadow that came before."
        ]
      }
      // ADD MORE GOOD-ALIGNED REPUTATION PHRASES HERE
    },

    evil: {
      aligned: {
        prominent: [
          "Among common folk, its name is used like a curse, invoked when something goes badly wrong for no obvious reason.",
          "Parents whisper its story to frighten children from wandering where they shouldn’t.",
          "Smugglers and mercenaries swap tall tales about the item over cheap ale, each insisting they know someone who saw it and barely survived."
        ],
        obscure: [
          "Most people have never heard of it, but a handful of old-timers flinch at its description as if recalling something they hoped to forget.",
          "In isolated villages, it appears in one or two local ghost stories, never quite the same twice.",
          "To most, the item is just a nameless 'cursed thing' mentioned in the margins of other, louder legends."
        ]
      },
      corrupted: {
        prominent: [
          "Bards sing of it as a cautionary tale, the 'hero’s relic that turned on its bearer' whenever pride or despair took hold.",
          "Some stories insist you can tell when it’s near because good luck twists into its opposite without warning.",
          "Temple sermons invoke it as a warning about trusting power that has tasted too much blood."
        ],
        obscure: [
          "In old soldiers’ circles, there are muttered references to a once-trusted relic that brought only grief in the end.",
          "Only specialists and survivors tend to recognize its sigil; everyone else mistakes it for some forgotten badge.",
          "Those who know a little of its history avoid saying its former name aloud, content to call it 'the Turned Relic'."
        ]
      }
      // ADD MORE EVIL-ALIGNED REPUTATION PHRASES HERE
    }
  };

    function generateItemReputation(originData, historyData) {
    if (!originData) {
      return {
        text: "Most people have never heard anything reliable about the item.",
        prominence: "obscure"
      };
    }

    const itemAxis = originData.itemAxis;        // "good" or "evil"
    const itemState = originData.itemState;      // "aligned" | "corrupted" | "sanctified"
    const hooks = (historyData && historyData.hooks) ? historyData.hooks : {};

    // Decide how widely known it is
    const highProfile = !!(
      hooks.hasRumors ||
      hooks.hasProphecy ||
      hooks.activelySoughtByNotorious ||
      hooks.eventOfWeal ||
      hooks.eventOfWoe
    );
    const prominence = highProfile ? "prominent" : "obscure";

    const axisBlock = REPUTATION_SENTENCES[itemAxis];
    if (!axisBlock) {
      return {
        text: "Most people speak of it only in vague, second-hand stories.",
        prominence: prominence
      };
    }

    // Collapse states: corrupted/sanctified get their own entries; all others use "aligned"
    let stateKey = "aligned";
    if (itemState === "corrupted" || itemState === "sanctified") {
      stateKey = itemState;
    }

    const stateBlock = axisBlock[stateKey] || axisBlock.aligned;
    const pool =
      (stateBlock && stateBlock[prominence]) ||
      (stateBlock && stateBlock.prominent) ||
      (stateBlock && stateBlock.obscure);

    if (!pool || pool.length === 0) {
      return {
        text: "Most people speak of it only in vague, second-hand stories.",
        prominence: prominence
      };
    }

    return {
      text: randomFrom(pool),
      prominence: prominence
    };
  }

  // ---------------------------
  //  WHO WANTS IT DESTROYED?
  // ---------------------------
  // Profiles keyed by itemAxis + itemState:
  //   "good_aligned", "good_sanctified", "evil_aligned", "evil_corrupted"
  // plus a "fallback".
  //
  // Each entry is a small faction / group that would prefer the item be
  // unmade, sealed forever, or erased from history.

  const DESTROY_FACTIONS = {
    good_aligned: [
      {
        id: "cautious_synod",
        alignment: "good",
        role: "cautious synod of priests",
        templates: [
          "A cautious synod of priests quietly argues that no relic should wield so much unaccountable influence, and they press for the item to be dismantled or sealed away for good.",
          "Within the faith, a conservative council insists the item’s power encourages reckless reliance on miracles and should be ritually unmade before it teaches the wrong lessons.",
          "A circle of theologians advocates for locking the item in a lightless vault, claiming that even benevolent relics distort mortal responsibility."
        ]
      },
      {
        id: "jealous_order",
        alignment: "good",
        role: "jealous knightly order",
        templates: [
          "A jealous knightly order that never received the item’s blessing campaigns to have it 'safely retired', by which they mean destroyed under their supervision.",
          "An order of sanctified champions resents how legends center on the item instead of their vows, and some among them call for its destruction to refocus devotion on people, not tools."
        ]
      }
      // ADD MORE good_aligned DESTRUCTION FACTIONS HERE
    ],

    good_sanctified: [
      {
        id: "purist_inquisition",
        alignment: "lawful_good",
        role: "purist inquisition",
        templates: [
          "A purist inquisition rejects the very idea of redeeming a wicked relic and pushes for the item to be shattered so thoroughly that no trace of its original stain survives.",
          "Hardline inquisitors maintain that the item’s sanctification was a mistake and campaign to see it cast into consecrated fire until nothing but harmless ash remains.",
          "Among the most severe clergy, there is a faction that regards the item as a ticking blasphemy and seeks to erase both it and the story of its redemption."
        ]
      },
      {
        id: "ashkeep_order",
        alignment: "neutral_good",
        role: "Order of the Ashkeep",
        templates: [
          "The Order of the Ashkeep, a sect devoted to burning away cursed things, quietly includes the item on a short list of relics they believe 'did not burn long enough'.",
          "Ashkeeps—wandering purifiers who specialize in unmaking dangerous magic—have long whispered that the item’s story should end in smoke, not incense."
        ]
      }
      // ADD MORE good_sanctified DESTRUCTION FACTIONS HERE
    ],

    evil_aligned: [
      {
        id: "radiant_crusade",
        alignment: "good",
        role: "radiant crusade",
        templates: [
          "A radiant crusade has standing orders to unmake the item wherever it appears, treating its destruction as a holy victory equal to felling a demon or burning a nest of cultists.",
          "An alliance of temples maintains a sealed writ authorizing any agent to risk life and limb to see the item destroyed, no questions asked afterward.",
          "A band of relic-breakers sponsored by several good-aligned churches has marked the item as a priority target, hoping to end a long line of tragedies at its source."
        ]
      },
      {
        id: "pragmatic_cabal",
        alignment: "neutral",
        role: "pragmatic cabal",
        templates: [
          "A pragmatic cabal of mages wants the item destroyed not out of morality, but because its unpredictable influence interferes with their own carefully balanced schemes.",
          "Certain crime lords would rather see the item erased from the board entirely than risk it falling into a rival’s hands, and they have quietly funded efforts to locate and destroy it."
        ]
      }
      // ADD MORE evil_aligned DESTRUCTION FACTIONS HERE
    ],

    evil_corrupted: [
      {
        id: "remorseful_order",
        alignment: "good",
        role: "remorseful order",
        templates: [
          "The very order that once hailed the item as a blessing now treats it as a shameful mistake and dispatches small, desperate bands to find and destroy it wherever rumor places it.",
          "A fellowship of repentant veterans, haunted by what the corrupted relic did in their hands, has sworn to track it down and end its story at any cost.",
          "Those who survived its last catastrophe meet in secret, sharing information and quietly funding anyone who promises to break the item beyond repair."
        ]
      },
      {
        id: "void_scholars",
        alignment: "neutral",
        role: "order of void-scholars",
        templates: [
          "An order of void-scholars insists the item has become a metaphysical hazard and advocates casting it into places where even magic cannot easily retrieve it.",
          "Morticians of magic—specialists in ending dangerous workings—consider the item an overdue case and petition for its final annihilation."
        ]
      }
      // ADD MORE evil_corrupted DESTRUCTION FACTIONS HERE
    ],

    fallback: [
      {
        id: "lonely_scholar",
        alignment: "neutral",
        role: "lonely scholar",
        templates: [
          "Only a lonely scholar or two seem to care enough to argue that the item ought to be dismantled before it causes trouble again.",
          "So far, the notion of destroying the item is little more than a footnote in a scholar’s marginalia, but it is a footnote written in increasingly urgent ink."
        ]
      }
      // ADD MORE FALLBACK DESTRUCTION FACTIONS HERE
    ]
  };

   function generateDestructionFaction(originData, historyData, locationData, reputationData) {
    if (!originData) {
      return {
        text: "If anyone has sworn to see the item destroyed, their efforts have left little trace in the records you’ve found.",
        id: null,
        alignment: "unknown",
        role: "unknown"
      };
    }

    const itemAxis  = originData.itemAxis;   // "good" or "evil"
    const itemState = originData.itemState;  // "aligned" | "corrupted" | "sanctified"
    const hooks     = (historyData && historyData.hooks) ? historyData.hooks : {};

    // Decide which profile to draw from
    let profileKey;
    if (itemAxis === "good") {
      profileKey = (itemState === "sanctified") ? "good_sanctified" : "good_aligned";
    } else if (itemAxis === "evil") {
      profileKey = (itemState === "corrupted") ? "evil_corrupted" : "evil_aligned";
    } else {
      profileKey = "fallback";
    }

    let pool = DESTROY_FACTIONS[profileKey];
    if (!pool || pool.length === 0) {
      pool = DESTROY_FACTIONS.fallback || [];
    }
    if (!pool || pool.length === 0) {
      return {
        text: "Few seem interested in destroying the item outright; for now, its fate is left to chance and circumstance.",
        id: null,
        alignment: "unknown",
        role: "unknown"
      };
    }

    const base = randomFrom(pool);
    let text   = randomFrom(base.templates);

    // Light tailoring based on how loud/dangerous its story is
    const highImpact = !!(
      hooks.eventOfWoe ||
      hooks.eventOfWeal ||
      hooks.thoughtLostOrDestroyed ||
      hooks.activelySoughtByNotorious
    );

    if (highImpact) {
      text += " Their petitions gain weight each time the item’s name surfaces in connection with fresh trouble.";
    } else if (hooks.hasRumors || hooks.hasProphecy) {
      text += " For now their cause is fueled more by ominous rumors and whispered prophecies than by hard evidence.";
    } else {
      text += " At present, theirs is a minority view, but one that could spread quickly if the item ever draws the wrong kind of attention.";
    }

    return {
      text: text,
      id: base.id,
      alignment: base.alignment,
      role: base.role
    };
  }

  // ---------------------------
  //  DORMANT vs AWAKENED POWER STATE
  // ---------------------------
  // powerStage: "dormant" | "awakened"
  // keyed by itemAxis so flavor shifts with good/evil

  const POWER_STATE_SENTENCES = {
    good: {
      dormant: [
        "For now, its magic lies mostly dormant, surfacing only in small, easily overlooked moments of grace.",
        "Those few who have handled it recently describe its power as a quiet weight, present but not eager.",
        "It behaves like a relic half asleep, answering only when moved by genuine need rather than spectacle."
      ],
      awakened: [
        "Lately, its power seems unusually responsive, flaring at the slightest echo of the causes it once served.",
        "Reports speak of the item ‘waking up’ in the presence of danger, its magic acting almost before the bearer can think.",
        "By all accounts, the item is wide awake again, eager to shape the next story told in its name."
      ]
    },
    evil: {
      dormant: [
        "If the item still stirs at all, it does so in slow, subtle ways that most would miss until too late.",
        "Its power clings like a lingering stain—faint enough to ignore, strong enough to twist the unwary over time.",
        "It broods rather than blazes, its malice felt more in uneasy dreams and small misfortunes than in open displays."
      ],
      awakened: [
        "Its power is said to be wide awake once more, answering eagerly to any hint of cruelty or ambition.",
        "Witnesses speak of an oppressive presence when it is near, as though the item itself is watching for an opportunity.",
        "Wherever it appears, events escalate quickly, as if the item is hungry to finish patterns it began long ago."
      ]
    },
    neutralFallback: {
      dormant: [
        "Most signs suggest the item’s deeper magic is sleeping, its presence felt more as potential than as action.",
        "It seems content to slumber in the background of events, waiting for the right conjunction of will and circumstance.",
        "Those attuned to such things describe it as ‘resting with one eye open’, neither eager nor entirely inert."
      ],
      awakened: [
        "Something in the item feels newly alert, as if it has decided the world is interesting again.",
        "Its magic sits near the surface now, ready to surge at the slightest nudge from fate or folly.",
        "By subtle or sudden signs, it has clearly shaken off whatever long quiet once bound it."
      ]
    }
  };

    function generatePowerState(originData, historyData, locationData, reputationData) {
    if (!originData) {
      return {
        powerStage: "dormant",
        score: 0,
        text: "If the item has any remaining power, it slumbers unnoticed and unremarked."
      };
    }

    const itemAxis = originData.itemAxis;    // "good" | "evil"
    const hooks    = (historyData && historyData.hooks) ? historyData.hooks : {};
    const secrecy  = locationData ? locationData.secrecy : "rumored";     // "obscure" | "rumored" | "well_known"
    const repProm  = reputationData ? reputationData.prominence : "obscure"; // "prominent" | "obscure"

    // Simple activity score:
    // positive = more "awake", negative = more "dormant"
    let score = 0;

    if (hooks.eventOfWeal) score += 2;
    if (hooks.eventOfWoe)  score += 2;
    if (hooks.activelySoughtByNotorious) score += 2;
    if (hooks.hasRumors)   score += 1;
    if (hooks.hasProphecy) score += 1;

    if (hooks.thoughtLostOrDestroyed) score -= 2;
    if (secrecy === "obscure")        score -= 1;
    if (secrecy === "well_known")     score += 1;
    if (repProm === "prominent")      score += 1;

    // A tiny random wobble so it's not completely deterministic
    score += (Math.random() < 0.5 ? 0 : 1);

    const powerStage = score >= 2 ? "awakened" : "dormant";

    // Pick the right flavor block
    let axisKey;
    if (itemAxis === "good" || itemAxis === "evil") {
      axisKey = itemAxis;
    } else {
      axisKey = "neutralFallback";
    }

    const axisBlock = POWER_STATE_SENTENCES[axisKey] || POWER_STATE_SENTENCES.neutralFallback;
    const pool      = axisBlock[powerStage] || POWER_STATE_SENTENCES.neutralFallback[powerStage];

    const text = pool && pool.length > 0
      ? randomFrom(pool)
      : (powerStage === "awakened"
          ? "Whatever else can be said of it, the item is no longer content to sleep."
          : "For the moment, the item’s power seems content to rest in the background of events.");

    return {
      powerStage,  // "dormant" or "awakened"
      score,
      text
    };
  }

  
  // ---------------------------
  //  Q3: LOCATION
  // ---------------------------

  const BASE_LOCATIONS = {
    goodAligned: [
      {
        id: "clifftop_monastery",
        category: "sacred",
        templates: [
          "The last reliable accounts place it in a storm-battered monastery perched on a cliff above the sea.",
          "It was last known to rest in a remote hillside abbey where the wind never quite falls silent.",
          "Old records suggest the item lies sealed beneath the altar of a mountain shrine reached only by narrow goat paths."
        ]
      },
      {
        id: "hero_tomb",
        category: "tomb",
        templates: [
          "Some say it lies entombed with its final heroic bearer in a barrow hidden beneath an overgrown hillside.",
          "It is rumored to rest in a mausoleum dedicated to forgotten champions, locked behind rusting gates of iron.",
          "The last mention describes it being interred with honors in a crypt deep under a ruined cathedral."
        ]
      }
      // ADD MORE GOOD-ALIGNED BASE LOCATIONS HERE
    ],
    evilAligned: [
      {
        id: "cabal_redoubt",
        category: "lair",
        templates: [
          "The last leads point toward a fortified redoubt once used by a secretive cabal in a city’s underbelly.",
          "Rumor has it the item was locked away in a warded vault beneath a den of criminals and hired blades.",
          "The trail ends at a cluster of safehouses along a smuggler’s coast, any one of which might conceal it."
        ]
      },
      {
        id: "cursed_ruins",
        category: "ruin",
        templates: [
          "Most who track the story agree it vanished somewhere within the cursed ruins of a sacked stronghold.",
          "Its name is now tied to a blighted battlefield where nothing healthy grows and the air tastes like old iron.",
          "The last expedition to seek it disappeared inside a toppled fortress, leaving only charred camp remains outside the walls."
        ]
      }
      // ADD MORE EVIL-ALIGNED BASE LOCATIONS HERE
    ],
    corrupted: [
      {
        id: "sealed_sanctum",
        category: "sealed",
        templates: [
          "Scholars suspect it was locked away in a sealed sanctum whose doors were never meant to open again.",
          "The final references speak of it being chained within a hidden chamber, circles of broken wards etched into the floor.",
          "One account claims the item was entombed in a vault of black stone, its entrance buried beneath deliberate rubble."
        ]
      },
      {
        id: "sunken_site",
        category: "sunken",
        templates: [
          "Some insist the site that once held it sank beneath dark waters after a calamity no one now recalls clearly.",
          "Old maps and half-burned notes suggest its resting place lies under a lake formed by the collapse of a dam.",
          "A few daring explorers say the ruins that sheltered it were swallowed by a bog that gurgles like a dying thing."
        ]
      }
      // ADD MORE CORRUPTED-ITEM LOCATIONS HERE
    ],
    sanctified: [
      {
        id: "reliquary",
        category: "reliquary",
        templates: [
          "Most modern accounts place it in a guarded reliquary, its once-dark surface now ringed with votive candles.",
          "It is said to rest within a sanctified vault lined with offerings from those who claim its touch aided them.",
          "The item reportedly lies cradled in a crystal case at the heart of a modest shrine, visited by quiet pilgrims."
        ]
      },
      {
        id: "hidden_hermitage",
        category: "hermitage",
        templates: [
          "Some whisper that a reclusive mystic keeps it hidden in a remote hermitage, far from any altar or banner.",
          "The trail ends at mention of a half-forgotten retreat in the hills, where a handful of wardens guard something they rarely speak of.",
          "A few scattered notes hint that a wandering ascetic bears the item in secret, resting only in wayside shrines known to few."
        ]
      }
      // ADD MORE SANCTIFIED-ITEM LOCATIONS HERE
    ]
  };

  function pickBaseLocation(itemAxis, itemState) {
    let key;
    if (itemState === "corrupted") {
      key = "corrupted";
    } else if (itemState === "sanctified") {
      key = "sanctified";
    } else {
      key = itemAxis === "good" ? "goodAligned" : "evilAligned";
    }

    const choices = BASE_LOCATIONS[key];
    if (!choices || choices.length === 0) return null;
    const entry = randomFrom(choices);
    const template = randomFrom(entry.templates);

    return {
      id: entry.id,
      category: entry.category,
      text: template
    };
  }

  function buildLocationFateTail(itemAxis, itemState, hooks) {
    const lost = hooks.thoughtLostOrDestroyed;
    const sought = hooks.activelySoughtByNotorious;
    const byGroup = hooks.linkedToNotoriousGroup;
    const byIndividual = hooks.linkedToNotoriousIndividual;

    const tails = [];

    if (lost && sought) {
      tails.push(
        "Most believe the site itself to be compromised or collapsed, yet determined seekers still comb the region for any remaining way in."
      );
    } else if (lost) {
      tails.push(
        "If the reports are true, the place that once held it has long since fallen into ruin, and its exact resting spot is now a matter of conjecture."
      );
    } else if (sought) {
      tails.push(
        "Various factions quietly circulate maps and half-legible notes, hoping to reach it before anyone else does."
      );
    }

    if (byGroup && !byIndividual) {
      tails.push(
        itemAxis === "good"
          ? "The order associated with the item claims to have secured the area, but their records are frustratingly incomplete."
          : "The cabal rumored to have used the item is said to keep eyes on the region, watching for interlopers."
      );
    } else if (byIndividual && !byGroup) {
      tails.push(
        itemAxis === "good"
          ? "Stories of its last bearer sometimes point would-be seekers toward the surrounding lands, but never with much detail."
          : "Those who knew its last notorious wielder hint that clues to the site can be found in the paths they favored."
      );
    }

    if (tails.length === 0) return null;
    return tails.join(" ");
  }

  function generateItemLocation(originData, historyData) {
    if (!originData) {
      return {
        text: "No reliable accounts mention where the item might be now.",
        category: "unknown",
        secrecy: "obscure",
        baseId: null
      };
    }

    const itemAxis = originData.itemAxis;
    const itemState = originData.itemState;
    const hooks = (historyData && historyData.hooks) ? historyData.hooks : {};

    const base = pickBaseLocation(itemAxis, itemState);
    if (!base) {
      return {
        text: "No reliable accounts mention where the item might be now.",
        category: "unknown",
        secrecy: "obscure",
        baseId: null
      };
    }

    const tail = buildLocationFateTail(itemAxis, itemState, hooks);
    const text = tail ? base.text + " " + tail : base.text;

    let secrecy = "rumored";
    if (hooks.thoughtLostOrDestroyed && !hooks.activelySoughtByNotorious) {
      secrecy = "obscure";
    } else if (hooks.activelySoughtByNotorious && !hooks.thoughtLostOrDestroyed) {
      secrecy = "well_known";
    }

    return {
      text: text,
      category: base.category,
      secrecy: secrecy,
      baseId: base.id
    };
  }

  // ---------------------------
  //  Q4: WITNESS
  // ---------------------------

  const WITNESS_BASE = {
    good: {
      aligned: [
        {
          id: "temple_historian",
          alignment: "good",
          role: "temple historian",
          templates: [
            "A cautious temple historian knows more than they will put to parchment, keeping the most troubling details locked behind a weary smile.",
            "An aging chronicler of a local shrine has pieced together an unnerving number of references to the item across old battle reports.",
            "A soft-spoken archivist in a cloistered library has long suspected the item’s story underlies several supposedly unrelated legends."
          ]
        },
        {
          id: "order_veteran",
          alignment: "good",
          role: "retired knight of the order",
          templates: [
            "A retired knight of the order that once bore the item still carries memories they share only with those they judge worthy.",
            "One weathered veteran of forgotten campaigns can describe the item’s glow on the battlefield as if they saw it yesterday.",
            "A grizzled guardian in simple clothes watches the shrine’s doorway with the quiet vigilance of someone who has seen what the item can do."
          ]
        }
        // ADD MORE GOOD-ALIGNED, ALIGNED-STATE WITNESSES HERE
      ],
      corrupted: [
        {
          id: "penitent_scholar",
          alignment: "good",
          role: "penitent scholar",
          templates: [
            "A penitent scholar in a remote cloister studies the item’s fall as a warning, their notes full of crossed-out names and second thoughts.",
            "A grey-robed historian who once approved the item’s use now catalogues every sign of its corruption with grim determination.",
            "An anxious lorekeeper, haunted by the part their order played in its downfall, has sworn to guide any would-be bearer more carefully."
          ]
        }
        // ADD MORE GOOD-ORIGIN, CORRUPTED-STATE WITNESSES HERE
      ],
      sanctified: [
        {
          id: "radiant_chronicler",
          alignment: "good",
          role: "radiant chronicler",
          templates: [
            "A radiant chronicler of miracles keeps a thin, well-thumbed volume devoted solely to the item’s unlikely redemption.",
            "A bright-eyed acolyte can recount, almost word for word, the liturgy that marks the night the item’s nature was changed.",
            "An elderly priest, more amused than awed, tells how something once feared became a symbol of second chances."
          ]
        }
        // (Normally unused: sanctified requires evil origin; kept for completeness.)
      ]
    },
    evil: {
      aligned: [
        {
          id: "blackmarket_broker",
          alignment: "neutral",
          role: "black-market broker",
          templates: [
            "A black-market broker with too many rings and too few scruples has quietly collected rumors and buyers’ names attached to the item.",
            "A fixer who arranges meetings in smoke-filled back rooms knows which coin purses twitch at the mention of the item.",
            "A smiling information dealer in the worst part of town can list, from memory, every bloody deal the item is said to have sweetened."
          ]
        },
        {
          id: "cabal_astrologer",
          alignment: "evil",
          role: "cabal astrologer",
          templates: [
            "An astrologer once in service to a secretive cabal tracks the item’s appearances through cryptic conjunctions and eclipses.",
            "A hooded seer who reads omens in spilled blood claims the item’s shadow still falls across their visions.",
            "A reclusive diviner, dismissed from their coven, insists that every major misfortune in the region carries the item’s faint signature."
          ]
        }
        // ADD MORE EVIL-ALIGNED, ALIGNED-STATE WITNESSES HERE
      ],
      corrupted: [
        {
          id: "grim_inquisitor",
          alignment: "lawful_good",
          role: "grim inquisitor",
          templates: [
            "A grim inquisitor has built an entire casefile around the item, treating it as both evidence and suspect.",
            "A hard-eyed investigator for a distant temple considers the item a missing piece in a chain of tragedies they are sworn to end.",
            "An uncompromising agent of a holy order carries sketches and notes about the item, each marked with warnings in red ink."
          ]
        }
        // (Normally unused: corrupted requires good origin; kept for flexibility.)
      ],
      sanctified: [
        {
          id: "cleansing_witness",
          alignment: "good",
          role: "witness of the cleansing",
          templates: [
            "A tired but satisfied exorcist can recount in meticulous detail the rite that stripped the item of much of its original malice.",
            "One of the officiants who presided over its sanctification still wakes from dreams in which the item resists their prayers.",
            "A once-shadowed priest now speaks calmly of the night the item’s aura shifted from hunger to hesitant warmth."
          ]
        }
        // ADD MORE EVIL-ORIGIN, SANCTIFIED-STATE WITNESSES HERE
      ]
    }
  };

  function pickWitnessBase(originAxis, itemState, hooks) {
    const axisGroup = WITNESS_BASE[originAxis];
    if (!axisGroup) return null;

    const stateKey = axisGroup[itemState] ? itemState : "aligned";
    const candidates = axisGroup[stateKey];
    if (!candidates || candidates.length === 0) return null;

    const byGroup = hooks && hooks.linkedToNotoriousGroup;
    if (byGroup && candidates.length > 1) {
      const biased = candidates.slice(1);
      if (biased.length > 0) {
        return randomFrom(biased);
      }
    }

    return randomFrom(candidates);
  }

  const WITNESS_LOCATION_TAILS = {
    sacred: [
      "They seldom leave the sacred grounds, insisting that the story of the item is safest told in hushed tones near consecrated stone.",
      "They insist any serious discussion take place within the temple’s inner chambers, far from casual ears.",
      "Their voice lowers whenever the item is mentioned, as though wary of disturbing something that still listens from the walls."
    ],
    tomb: [
      "They warn that disturbing the resting place without proper rites would be an unkindness to both the dead and the living.",
      "They carry a small key or token said to open only for those who show proper respect at the tomb.",
      "Their memories of that crypt are precise, but they refuse to say whether they would ever go back there themselves."
    ],
    lair: [
      "They advise that no one go near the site without allies they deeply trust, and even then only with a clear escape plan.",
      "They describe the lair in clipped, practical terms, as if planning a raid they secretly hope will never happen.",
      "Their hands shake slightly when recalling the sounds from that place, though they insist the worst of it is over."
    ],
    ruin: [
      "They can sketch the ruins from memory, but admit that the surrounding landscape has shifted more than once since they last saw it.",
      "They talk about the ruins as if they were a living thing that resents being mapped.",
      "They caution that the ruin’s layout is never quite the same between visits, as though the stones themselves drift."
    ],
    sealed: [
      "They claim to have seen the seals with their own eyes and are convinced breaking them would be a grave mistake.",
      "They describe the sealing rites in unsettling detail, as if daring others to test whether they still hold.",
      "They refuse to say who ordered the chamber sealed, muttering only that some names are safer forgotten."
    ],
    sunken: [
      "They keep a stained chart of the waters locked away, taking it out only when pressed by desperate or foolish seekers.",
      "They speak of the currents and hidden depths as if they were enemies that once nearly claimed them.",
      "Their tale always ends with the same advice: if the item truly lies beneath those waters, perhaps it should stay there."
    ],
    reliquary: [
      "They know the rotation of the reliquary’s guardians by heart, though they claim this is merely professional habit.",
      "They insist the item is well-watched, yet their eyes keep drifting toward the door as if expecting someone to interrupt.",
      "They hint that even within the reliquary, the item sometimes draws unexpected visitors from far away."
    ],
    hermitage: [
      "They admit that finding the hermitage again would require following half-remembered paths and old instincts.",
      "They speak fondly of the hermit who watches over the item, but never quite say how long it has been since they last met.",
      "They suggest that those who truly need the item will be able to find the hermitage—eventually."
    ],
    default: [
      "They know just enough to point you in a direction, though their expression suggests they might sleep better if you never went.",
      "They admit their knowledge is second-hand, but the consistency of their story suggests deeper experience they will not share.",
      "They seem torn between relief that someone else is asking and regret that the tale has not yet ended."
    ]
    // ADD MORE WITNESS LOCATION-TAIL VARIANTS PER CATEGORY HERE
  };

  function buildWitnessLocationTail(category, hooks) {
    const list = WITNESS_LOCATION_TAILS[category] || WITNESS_LOCATION_TAILS.default;
    if (!list || list.length === 0) return null;
    return randomFrom(list);
  }

  function generateItemWitness(originData, historyData, locationData) {
    if (!originData || !originData.creator) {
      return {
        text: "If anyone knows more of the item, their name has not survived in the tales you have found.",
        role: "unknown",
        alignment: "unknown",
        id: null
      };
    }

    const originAxis = originData.originAxis;
    const itemState = originData.itemState;
    const hooks = (historyData && historyData.hooks) ? historyData.hooks : {};
    const category = locationData ? locationData.category : "unknown";

    const base = pickWitnessBase(originAxis, itemState, hooks);
    if (!base) {
      return {
        text: "There are hints of a nameless witness who knows more, but no clear description of who or where they might be found.",
        role: "unknown",
        alignment: "unknown",
        id: null
      };
    }

    const baseText = randomFrom(base.templates);
    const tail = buildWitnessLocationTail(category, hooks);
    const text = tail ? baseText + " " + tail : baseText;

    return {
      text: text,
      role: base.role,
      alignment: base.alignment,
      id: base.id
    };
  }

  // ---------------------------
  //  UI WIRING
  // ---------------------------

  let lastOrigin = null;
  let lastHistory = null;
  let lastLocation = null;
  let lastWitness = null;
  let lastReputation = null;
  let lastDestroyer = null;
  let lastPowerState = null;
  

  function rollTraits() {
    lastOrigin = generateCreatorOrigin();
    lastHistory = generateItemHistory(lastOrigin);
    lastLocation = generateItemLocation(lastOrigin, lastHistory);
    lastWitness = generateItemWitness(lastOrigin, lastHistory, lastLocation);
    lastReputation = generateItemReputation(lastOrigin, lastHistory);
    lastDestroyer  = generateDestructionFaction(lastOrigin, lastHistory, lastLocation, lastReputation);
    lastPowerState = generatePowerState(lastOrigin, lastHistory, lastLocation, lastReputation);


    const originEl = document.getElementById("originOutput");
    const historyEl = document.getElementById("historyOutput");
    const locationEl = document.getElementById("locationOutput");
    const witnessEl = document.getElementById("witnessOutput");
    const reputationEl  = document.getElementById("reputationOutput");
    const destroyerEl  = document.getElementById("destroyerOutput");
    const powerEl      = document.getElementById("powerStateOutput");
    const metaEl = document.getElementById("metaOutput");

    originEl.textContent = lastOrigin.text || "";
    historyEl.textContent = lastHistory.text || "";
    locationEl.textContent = lastLocation.text || "";
    witnessEl.textContent = lastWitness.text || "";
    reputationEl.textContent = lastReputation && lastReputation.text ? lastReputation.text : "";
    destroyerEl.textContent  = lastDestroyer && lastDestroyer.text ? lastDestroyer.text : "";
    powerEl.textContent = lastPowerState && lastPowerState.text ? lastPowerState.text : "";

    if (lastOrigin.creator) {
      metaEl.textContent =
        "Tone: " +
        lastOrigin.originAxis +
        "-aligned origin, item is " +
        lastOrigin.itemAxis +
        "-aligned (" +
        lastOrigin.itemState +
        ").";
    } else {
      metaEl.textContent = "";
    }
  }

  function generateLoreParagraph() {
    if (!lastOrigin) {
      rollTraits();
    }

    const loreEl = document.getElementById("loreOutput");
    loreEl.innerHTML = ""; // clear previous output

    const parts = [];
    if (lastOrigin && lastOrigin.text) parts.push(lastOrigin.text);
    if (lastHistory && lastHistory.text) parts.push(lastHistory.text);
    if (lastLocation && lastLocation.text) parts.push(lastLocation.text);
    if (lastReputation && lastReputation.text) parts.push(lastReputation.text);
    if (lastWitness && lastWitness.text) parts.push(lastWitness.text);
    if (lastDestroyer && lastDestroyer.text)   parts.push(lastDestroyer.text);
    if (lastPowerState && lastPowerState.text) parts.push(lastPowerState.text);

    parts.forEach(text => {
      const p = document.createElement("p");
      p.textContent = text;
      loreEl.appendChild(p);
    });
  }

  document.getElementById("rollTraitsBtn").addEventListener("click", rollTraits);
  document.getElementById("generateLoreBtn").addEventListener("click", generateLoreParagraph);

})();
</script>
</body>
</html>
